name: Prepare NIPR Transfer Archives

on:
  workflow_dispatch:
    inputs:
      sync_mirrors:
        description: "Sync YUM/DNF repository mirrors"
        required: false
        default: true
        type: boolean
      sync_roles:
        description: "Vendor Ansible roles"
        required: false
        default: true
        type: boolean
      sync_packages:
        description: "Download offline packages"
        required: false
        default: true
        type: boolean
      create_archives:
        description: "Create transfer archives"
        required: false
        default: true
        type: boolean
      upload_artifacts:
        description: "Upload archives as GitHub artifacts"
        required: false
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  prepare-nipr-transfer:
    name: Prepare NIPR Transfer Archives
    runs-on: ubuntu-latest
    timeout-minutes: 480  # 8 hours for large mirror sync
    
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            dnf \
            createrepo-c \
            hardlink \
            wget \
            git \
            tar \
            gzip
      
      - name: Set up environment variables
        run: |
          echo "DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
          echo "SPEL_VERSION=$(date +%Y.%m).1" >> $GITHUB_ENV
          
          # Storage optimization settings
          echo "SPEL_MIRROR_EXCLUDE_DEBUG=true" >> $GITHUB_ENV
          echo "SPEL_MIRROR_EXCLUDE_SOURCE=true" >> $GITHUB_ENV
          echo "SPEL_MIRROR_COMPRESS=true" >> $GITHUB_ENV
          echo "SPEL_MIRROR_HARDLINK=true" >> $GITHUB_ENV
          
          echo "SPEL_ROLES_REMOVE_GIT=true" >> $GITHUB_ENV
          echo "SPEL_ROLES_COMPRESS=true" >> $GITHUB_ENV
          
          echo "SPEL_OFFLINE_COMPRESS=true" >> $GITHUB_ENV
          echo "SPEL_OFFLINE_VERIFY=true" >> $GITHUB_ENV
          
          echo "SPEL_ARCHIVE_SEPARATE=true" >> $GITHUB_ENV
          echo "SPEL_ARCHIVE_COMBINED=true" >> $GITHUB_ENV
          echo "SPEL_ARCHIVE_MIRRORS=true" >> $GITHUB_ENV
      
      - name: Display configuration
        run: |
          echo "=== NIPR Transfer Preparation Configuration ==="
          echo "Date: $DATE"
          echo "SPEL Version: $SPEL_VERSION"
          echo ""
          echo "Tasks:"
          echo "  Sync Mirrors: ${{ github.event.inputs.sync_mirrors }}"
          echo "  Vendor Roles: ${{ github.event.inputs.sync_roles }}"
          echo "  Download Packages: ${{ github.event.inputs.sync_packages }}"
          echo "  Create Archives: ${{ github.event.inputs.create_archives }}"
          echo "  Upload Artifacts: ${{ github.event.inputs.upload_artifacts }}"
          echo ""
          echo "Storage Optimization:"
          echo "  Exclude debug packages: $SPEL_MIRROR_EXCLUDE_DEBUG"
          echo "  Exclude source packages: $SPEL_MIRROR_EXCLUDE_SOURCE"
          echo "  Compress repositories: $SPEL_MIRROR_COMPRESS"
          echo "  Remove .git from roles: $SPEL_ROLES_REMOVE_GIT"
          echo "================================================"
      
      - name: Sync YUM/DNF repository mirrors
        if: github.event.inputs.sync_mirrors != 'false'
        run: |
          echo "=== Syncing YUM/DNF Mirrors with Optimizations ==="
          ./scripts/sync-mirrors.sh
          
          echo ""
          echo "Mirror sizes:"
          du -sh mirrors/*/
          echo ""
          echo "Total mirror size:"
          du -sh mirrors/
      
      - name: Vendor Ansible roles
        if: github.event.inputs.sync_roles != 'false'
        run: |
          echo "=== Vendoring Ansible Roles ==="
          ./scripts/vendor-ansible-roles.sh
          
          echo ""
          echo "Role sizes:"
          du -sh spel/ansible/roles/*/
          echo ""
          echo "Total roles size:"
          du -sh spel/ansible/roles/
      
      - name: Download offline packages
        if: github.event.inputs.sync_packages != 'false'
        run: |
          echo "=== Downloading Offline Packages ==="
          ./scripts/download-offline-packages.sh
          
          echo ""
          echo "Package files:"
          ls -lh offline-packages/
          echo ""
          echo "Total packages size:"
          du -sh offline-packages/
      
      - name: Create transfer archives
        if: github.event.inputs.create_archives != 'false'
        run: |
          echo "=== Creating Transfer Archives ==="
          ./scripts/create-transfer-archive.sh
          
          echo ""
          echo "Created archives:"
          ls -lh spel-*.tar.gz
      
      - name: Verify checksums
        if: github.event.inputs.create_archives != 'false'
        run: |
          echo "=== Verifying Archive Checksums ==="
          sha256sum -c spel-nipr-${DATE}-checksums.txt
          
          echo ""
          echo "Checksum verification passed!"
      
      - name: Generate transfer manifest
        if: github.event.inputs.create_archives != 'false'
        run: |
          MANIFEST_FILE="spel-nipr-${DATE}-manifest.txt"
          
          cat > "$MANIFEST_FILE" <<MANIFEST_EOF
          SPEL NIPR Transfer Manifest
          ============================
          Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          SPEL Version: ${SPEL_VERSION}
          GitHub Workflow: ${{ github.workflow }}
          Run Number: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          
          Archives
          --------
          MANIFEST_EOF
          
          for archive in spel-*.tar.gz; do
            if [ -f "$archive" ]; then
              size=$(du -h "$archive" | awk '{print $1}')
              sha256=$(sha256sum "$archive" | awk '{print $1}')
              echo "$archive ($size)" >> "$MANIFEST_FILE"
              echo "  SHA256: $sha256" >> "$MANIFEST_FILE"
            fi
          done
          
          cat >> "$MANIFEST_FILE" <<MANIFEST_EOF
          
          Total Size
          ----------
          MANIFEST_EOF
          du -ch spel-*.tar.gz | tail -1 >> "$MANIFEST_FILE"
          
          cat >> "$MANIFEST_FILE" <<MANIFEST_EOF
          
          Transfer Instructions
          ---------------------
          1. Verify checksums: sha256sum -c spel-nipr-${DATE}-checksums.txt
          2. Transfer all spel-*.tar.gz files to NIPR environment
          3. Transfer spel-nipr-${DATE}-checksums.txt for verification
          4. On NIPR: verify checksums again after transfer
          5. On NIPR: run ./scripts/extract-nipr-archives.sh
          6. On NIPR: run sudo ./scripts/setup-local-repos.sh
          
          Storage Optimization Applied
          ----------------------------
          - Excluded debug/source packages from mirrors (saves ~70%)
          - Removed .git directories from Ansible roles (saves ~80%)
          - Used single SSM agent for EL8/EL9 (saves ~25%)
          - Created compressed archives (saves ~60% transfer size)
          
          Expected Sizes
          --------------
          - Mirrors (optimized): 30-50 GB
          - Compressed transfer: 12-20 GB
          - Total reduction: ~70% vs unoptimized
          MANIFEST_EOF
          
          echo "=== Transfer Manifest ==="
          cat "$MANIFEST_FILE"
      
      - name: Display summary
        run: |
          echo ""
          echo "========================================="
          echo "NIPR Transfer Preparation Complete!"
          echo "========================================="
          echo ""
          echo "Archives created:"
          ls -lh spel-*.tar.gz 2>/dev/null | awk '{printf "  %-50s %10s\n", $9, $5}' || echo "  None"
          echo ""
          echo "Total archive size:"
          du -ch spel-*.tar.gz 2>/dev/null | tail -1 | awk '{print "  " $1}' || echo "  N/A"
          echo ""
          echo "Files ready for transfer:"
          echo "  - spel-nipr-${DATE}-checksums.txt (verification)"
          echo "  - spel-nipr-${DATE}-manifest.txt (documentation)"
          echo "  - spel-*.tar.gz (archives)"
          echo ""
          echo "Next steps:"
          echo "  1. Download artifacts from GitHub Actions"
          echo "  2. Verify checksums locally"
          echo "  3. Transfer to NIPR using approved method"
          echo "  4. Set up GitLab CI in NIPR for automated deployment"
          echo "========================================="
      
      - name: Upload transfer archives
        if: github.event.inputs.upload_artifacts != 'false' && github.event.inputs.create_archives != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: spel-nipr-transfer-${{ env.DATE }}
          path: |
            spel-*.tar.gz
            spel-nipr-*-checksums.txt
            spel-nipr-*-manifest.txt
          retention-days: 90
          compression-level: 0
      
      - name: Upload component artifacts (base only)
        if: github.event.inputs.upload_artifacts != 'false' && github.event.inputs.create_archives != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: spel-nipr-base-${{ env.DATE }}
          path: spel-base-*.tar.gz
          retention-days: 90
          compression-level: 0
      
      - name: Create summary
        if: always()
        run: |
          echo "## NIPR Transfer Preparation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**SPEL Version:** ${SPEL_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Archives Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Archive | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          for archive in spel-*.tar.gz; do
            if [ -f "$archive" ]; then
              size=$(du -h "$archive" | awk '{print $1}')
              echo "| \`$archive\` | $size |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          total_size=$(du -ch spel-*.tar.gz 2>/dev/null | tail -1 | awk '{print $1}' || echo "N/A")
          echo "| **Total** | **$total_size** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Storage Optimization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Excluded debug/source packages (saves ~70%)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Removed git history from roles (saves ~80%)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Single SSM agent for EL8/EL9 (saves ~25%)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Compressed archives (saves ~60% transfer)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download artifacts from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify checksums: \`sha256sum -c spel-nipr-${DATE}-checksums.txt\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Transfer archives to NIPR environment" >> $GITHUB_STEP_SUMMARY
          echo "4. Extract on NIPR: \`./scripts/extract-nipr-archives.sh\`" >> $GITHUB_STEP_SUMMARY
          echo "5. Configure repos: \`sudo ./scripts/setup-local-repos.sh\`" >> $GITHUB_STEP_SUMMARY
