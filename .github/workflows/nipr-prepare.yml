name: Prepare NIPR Transfer Archives

on:
  workflow_dispatch:
    inputs:
      sync_spel:
        description: "Sync SPEL custom packages"
        required: false
        default: true
        type: boolean
      download_packer:
        description: "Download Packer binaries (Linux + Windows)"
        required: false
        default: true
        type: boolean
      download_packer_plugins:
        description: "Download Packer plugins"
        required: false
        default: true
        type: boolean
      download_ansible:
        description: "Download Ansible Core and dependencies"
        required: false
        default: true
        type: boolean
      download_collections:
        description: "Download Ansible collections"
        required: false
        default: true
        type: boolean
      sync_roles:
        description: "Vendor Ansible roles"
        required: false
        default: true
        type: boolean
      sync_packages:
        description: "Download offline packages"
        required: false
        default: true
        type: boolean
      create_archives:
        description: "Create transfer archives"
        required: false
        default: true
        type: boolean
      upload_artifacts:
        description: "Upload archives as GitHub artifacts"
        required: false
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  prepare-nipr-transfer:
    name: Prepare NIPR Transfer Archives
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    timeout-minutes: 90  # 1.5 hours for all downloads including Ansible and Packer plugins
    
    steps:
      - name: Install Git for checkout
        run: |
          dnf install -y git
      
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1
      
      - name: Install system dependencies
        run: |
          dnf install -y \
            dnf-plugins-core \
            createrepo_c \
            hardlink \
            wget \
            git \
            tar \
            gzip \
            findutils \
            which \
            python3.9 \
            python3-pip \
            unzip
      
      - name: Set up environment variables
        run: |
          echo "DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
          echo "SPEL_VERSION=$(date +%Y.%m).1" >> $GITHUB_ENV
          
          # Storage optimization settings for roles and packages
          echo "SPEL_ROLES_REMOVE_GIT=true" >> $GITHUB_ENV
          echo "SPEL_ROLES_COMPRESS=true" >> $GITHUB_ENV
          
          echo "SPEL_OFFLINE_COMPRESS=true" >> $GITHUB_ENV
          echo "SPEL_OFFLINE_VERIFY=true" >> $GITHUB_ENV
          
          echo "SPEL_ARCHIVE_SEPARATE=true" >> $GITHUB_ENV
          echo "SPEL_ARCHIVE_COMBINED=true" >> $GITHUB_ENV
          
          # Packer configuration
          echo "SPEL_PACKER_VERSION=1.11.2" >> $GITHUB_ENV
          echo "SPEL_PACKER_PLATFORMS=linux_amd64 windows_amd64" >> $GITHUB_ENV
          
          # Python configuration
          echo "SPEL_PYTHON_VERSION=3.9" >> $GITHUB_ENV
          echo "SPEL_ANSIBLE_VERSION=>=2.14.0,<2.16.0" >> $GITHUB_ENV
      
      - name: Display configuration
        run: |
          echo "=== NIPR Transfer Preparation Configuration ==="
          echo "Date: $DATE"
          echo "SPEL Version: $SPEL_VERSION"
          echo ""
          echo "Tasks:"
          echo "  Sync SPEL Packages: ${{ github.event.inputs.sync_spel }}"
          echo "  Download Packer: ${{ github.event.inputs.download_packer }}"
          echo "  Download Packer Plugins: ${{ github.event.inputs.download_packer_plugins }}"
          echo "  Download Ansible Core: ${{ github.event.inputs.download_ansible }}"
          echo "  Download Ansible Collections: ${{ github.event.inputs.download_collections }}"
          echo "  Vendor Roles: ${{ github.event.inputs.sync_roles }}"
          echo "  Download Packages: ${{ github.event.inputs.sync_packages }}"
          echo "  Create Archives: ${{ github.event.inputs.create_archives }}"
          echo "  Upload Artifacts: ${{ github.event.inputs.upload_artifacts }}"
          echo ""
          echo "Storage Optimization:"
          echo "  Remove .git from roles: $SPEL_ROLES_REMOVE_GIT"
          echo "  Packer version: $SPEL_PACKER_VERSION"
          echo "  Packer platforms: $SPEL_PACKER_PLATFORMS"
          echo "  Python version: $SPEL_PYTHON_VERSION"
          echo "  Ansible version: $SPEL_ANSIBLE_VERSION"
          echo ""
          echo "Note: YUM/DNF mirrors are NOT synced - NIPR has its own RPM repositories"
          echo "================================================="
      
      - name: Sync SPEL custom packages
        if: github.event.inputs.sync_spel != 'false'
        run: |
          echo "=== Syncing SPEL Custom Packages ==="
          ./scripts/sync-spel-packages.sh
          
          echo ""
          echo "SPEL packages:"
          find mirrors/spel-packages -name "*.rpm" -exec ls -lh {} \; 2>/dev/null || echo "No RPMs found"
          echo ""
          echo "Total SPEL packages size:"
          du -sh mirrors/spel-packages/
      
      - name: Download Packer binaries
        if: github.event.inputs.download_packer != 'false'
        run: |
          echo "=== Downloading Packer Binaries (Multi-Platform) ==="
          ./scripts/download-packer.sh
          
          echo ""
          echo "Packer binaries:"
          ls -lh tools/packer/*/packer* 2>/dev/null || echo "No binaries found"
          echo ""
          echo "Linux Packer version:"
          ./tools/packer/linux_amd64/packer version
      
      - name: Download Packer plugins
        if: github.event.inputs.download_packer_plugins != 'false'
        run: |
          echo "=== Downloading Packer Plugins ==="
          ./scripts/download-packer-plugins.sh
          
          echo ""
          echo "Plugin files:"
          find tools/packer/plugins -name "packer-plugin-*" -type f 2>/dev/null | head -10
          echo ""
          echo "Total plugins size:"
          du -sh tools/packer/plugins/
      
      - name: Verify Packer plugins
        if: github.event.inputs.download_packer_plugins != 'false'
        run: |
          echo "=== Verifying Packer Plugins ==="
          export PACKER_PLUGIN_PATH="${PWD}/tools/packer/plugins"
          
          if ./tools/packer/linux_amd64/packer plugins installed; then
            echo ""
            echo "✓ Packer plugins verification successful"
          else
            echo ""
            echo "⚠ Warning: Packer plugin verification failed, but continuing..."
            echo "Plugins are already downloaded and checksummed."
          fi
      
      - name: Download Ansible Core and dependencies
        if: github.event.inputs.download_ansible != 'false'
        run: |
          echo "=== Downloading Ansible Core and Dependencies ==="
          ./scripts/download-ansible-core.sh
          
          echo ""
          echo "Python wheels:"
          ls -1 tools/python-deps/*.whl 2>/dev/null | wc -l | xargs echo "  Total wheels:"
          echo ""
          echo "Total Python deps size:"
          du -sh tools/python-deps/
      
      - name: Download Ansible collections
        if: github.event.inputs.download_collections != 'false'
        run: |
          echo "=== Downloading Ansible Collections ==="
          
          # Install ansible-core temporarily for ansible-galaxy command
          python3.9 -m pip install --user "ansible-core>=2.14.0,<2.16.0"
          
          ./scripts/vendor-ansible-collections.sh
          
          echo ""
          echo "Collection tarballs:"
          ls -lh spel/ansible/collections/*.tar.gz 2>/dev/null || echo "No collections found"
          echo ""
          echo "Total collections size:"
          du -sh spel/ansible/collections/
      
      - name: Vendor Ansible roles
        if: github.event.inputs.sync_roles != 'false'
        run: |
          echo "=== Vendoring Ansible Roles ==="
          ./scripts/vendor-ansible-roles.sh
          
          echo ""
          echo "Role sizes:"
          du -sh spel/ansible/roles/*/
          echo ""
          echo "Total roles size:"
          du -sh spel/ansible/roles/
      
      - name: Download offline packages
        if: github.event.inputs.sync_packages != 'false'
        run: |
          echo "=== Downloading Offline Packages ==="
          ./scripts/download-offline-packages.sh
          
          echo ""
          echo "Package files:"
          ls -lh offline-packages/
          echo ""
          echo "Total packages size:"
          du -sh offline-packages/
      
      - name: Create transfer archives
        if: github.event.inputs.create_archives != 'false'
        run: |
          echo "=== Creating Transfer Archives ==="
          ./scripts/create-transfer-archive.sh
          
          echo ""
          echo "Created archives:"
          ls -lh spel-*.tar.gz
      
      - name: Verify checksums
        if: github.event.inputs.create_archives != 'false'
        run: |
          echo "=== Verifying Archive Checksums ==="
          sha256sum -c spel-nipr-${DATE}-checksums.txt
          
          echo ""
          echo "Checksum verification passed!"
      
      - name: Generate transfer manifest
        if: github.event.inputs.create_archives != 'false'
        run: |
          MANIFEST_FILE="spel-nipr-${DATE}-manifest.txt"
          
          cat > "$MANIFEST_FILE" <<MANIFEST_EOF
          SPEL NIPR Transfer Manifest
          ============================
          Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          SPEL Version: ${SPEL_VERSION}
          GitHub Workflow: ${{ github.workflow }}
          Run Number: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          
          Archives
          --------
          MANIFEST_EOF
          
          for archive in spel-*.tar.gz; do
            if [ -f "$archive" ]; then
              size=$(du -h "$archive" | awk '{print $1}')
              sha256=$(sha256sum "$archive" | awk '{print $1}')
              echo "$archive ($size)" >> "$MANIFEST_FILE"
              echo "  SHA256: $sha256" >> "$MANIFEST_FILE"
            fi
          done
          
          cat >> "$MANIFEST_FILE" <<MANIFEST_EOF
          
          Total Size
          ----------
          MANIFEST_EOF
          du -ch spel-*.tar.gz | tail -1 >> "$MANIFEST_FILE"
          
          cat >> "$MANIFEST_FILE" <<MANIFEST_EOF
          
          Transfer Instructions
          ---------------------
          1. Verify checksums: sha256sum -c spel-nipr-${DATE}-checksums.txt
          2. Transfer all spel-*.tar.gz files to NIPR environment
          3. Transfer spel-nipr-${DATE}-checksums.txt for verification
          4. On NIPR: verify checksums again after transfer
          5. On NIPR: run ./scripts/extract-nipr-archives.sh
          6. On NIPR: configure to use NIPR RPM repositories (no local mirrors needed)
          
          Storage Optimization Applied
          ----------------------------
          - Removed .git directories from Ansible roles (saves ~80%)
          - Used single SSM agent for EL8/EL9 (saves ~25%)
          - Created compressed archives
          
          Expected Sizes
          --------------
          - Ansible Roles: ~60 MB
          - Ansible Collections: ~30 MB
          - Ansible Core (Python wheels): ~100 MB
          - Offline Packages: ~75 MB
          - SPEL Packages: ~20 MB
          - Packer Binaries (Linux + Windows): ~500 MB
          - Packer Plugins: ~80 MB
          - Build Scripts: ~100 MB
          - Total uncompressed: ~2-3 GB
          - Compressed transfer: ~2-2.5 GB
          
          Note: YUM/DNF mirrors are NOT included - NIPR environment
                uses its own RPM repositories
          MANIFEST_EOF
          
          echo "=== Transfer Manifest ==="
          cat "$MANIFEST_FILE"
      
      - name: Display summary
        run: |
          echo ""
          echo "========================================="
          echo "NIPR Transfer Preparation Complete!"
          echo "========================================="
          echo ""
          echo "Archives created:"
          ls -lh spel-*.tar.gz 2>/dev/null | awk '{printf "  %-50s %10s\n", $9, $5}' || echo "  None"
          echo ""
          echo "Total archive size:"
          du -ch spel-*.tar.gz 2>/dev/null | tail -1 | awk '{print "  " $1}' || echo "  N/A"
          echo ""
          echo "Contents:"
          echo "  - Ansible roles (vendored)"
          echo "  - Ansible collections (ansible.windows, community.windows)"
          echo "  - Ansible Core with Python dependencies"
          echo "  - Offline packages (AWS CLI, SSM Agent, CFN Bootstrap)"
          echo "  - SPEL custom packages"
          echo "  - Packer binaries (Linux + Windows v$SPEL_PACKER_VERSION)"
          echo "  - Packer plugins (all required for SPEL builds)"
          echo "  - Build scripts and configurations"
          echo ""
          echo "Note: YUM/DNF mirrors NOT included - use NIPR RPM repositories"
          echo ""
          echo "Files ready for transfer:"
          echo "  - spel-nipr-${DATE}-checksums.txt (verification)"
          echo "  - spel-nipr-${DATE}-manifest.txt (documentation)"
          echo "  - spel-*.tar.gz (archives)"
          echo ""
          echo "Next steps:"
          echo "  1. Download artifacts from GitHub Actions"
          echo "  2. Verify checksums locally"
          echo "  3. Transfer to NIPR using approved method"
          echo "  4. Set up GitLab CI in NIPR for automated deployment"
          echo "========================================="
      
      - name: Upload transfer archives
        if: github.event.inputs.upload_artifacts != 'false' && github.event.inputs.create_archives != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: spel-nipr-transfer-${{ env.DATE }}
          path: |
            spel-*.tar.gz
            spel-nipr-*-checksums.txt
            spel-nipr-*-manifest.txt
          retention-days: 90
          compression-level: 0
      
      - name: Upload component artifacts (base only)
        if: github.event.inputs.upload_artifacts != 'false' && github.event.inputs.create_archives != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: spel-nipr-base-${{ env.DATE }}
          path: spel-base-*.tar.gz
          retention-days: 90
          compression-level: 0
      
      - name: Create summary
        if: always()
        run: |
          echo "## NIPR Transfer Preparation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**SPEL Version:** ${SPEL_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Archives Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Archive | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          for archive in spel-*.tar.gz; do
            if [ -f "$archive" ]; then
              size=$(du -h "$archive" | awk '{print $1}')
              echo "| \`$archive\` | $size |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          total_size=$(du -ch spel-*.tar.gz 2>/dev/null | tail -1 | awk '{print $1}' || echo "N/A")
          echo "| **Total** | **$total_size** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Storage Optimization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Removed git history from roles (saves ~80%)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Single SSM agent for EL8/EL9 (saves ~25%)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Compressed archives" >> $GITHUB_STEP_SUMMARY
          echo "- ℹ️  YUM/DNF mirrors NOT included - NIPR uses its own RPM repositories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download artifacts from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify checksums: \`sha256sum -c spel-nipr-${DATE}-checksums.txt\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Transfer archives to NIPR environment" >> $GITHUB_STEP_SUMMARY
          echo "4. Extract on NIPR: \`./scripts/extract-nipr-archives.sh\`" >> $GITHUB_STEP_SUMMARY
          echo "5. Configure repos: \`sudo ./scripts/setup-local-repos.sh\`" >> $GITHUB_STEP_SUMMARY
