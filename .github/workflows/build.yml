name: Build STIGed AMI's

on:
  workflow_dispatch:
    inputs:
      offline_mode:
        description: "Use offline mode with NIPR artifacts"
        required: false
        default: false
        type: boolean
      nipr_artifact_name:
        description: "NIPR artifact name (e.g., spel-nipr-transfer-20251126)"
        required: false
        default: ""
        type: string
      # govcloud:
      #   description: "Copy AMI's to GovCloud"
      #   required: false
      #   default: false
      #   type: boolean
      run_amzn2023:
        description: "Run Amazon Linux 2023 builder"
        required: false
        default: false
        type: boolean
      run_ol9:
        description: "Run Oracle Linux 9 builder"
        required: false
        default: false
        type: boolean
      run_rhel9:
        description: "Run RHEL 9 builder"
        required: false
        default: false
        type: boolean
      run_ol8:
        description: "Run Oracle Linux 8 builder"
        required: false
        default: false
        type: boolean
      run_rhel8:
        description: "Run RHEL 8 builder"
        required: false
        default: false
        type: boolean
      run_ws2016:
        description: "Run Windows Server 2016 builder"
        required: false
        default: false
        type: boolean
      run_ws2019:
        description: "Run Windows Server 2019 builder"
        required: false
        default: false
        type: boolean
      run_ws2022:
        description: "Run Windows Server 2022 builder"
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: write

jobs:
  build:
    name: Build SPEL AMI's
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download NIPR artifacts for offline mode
        if: github.event.inputs.offline_mode == 'true'
        uses: dawidd6/action-download-artifact@v6
        with:
          name: ${{ github.event.inputs.nipr_artifact_name }}
          path: ./nipr-artifacts/
          workflow: nipr-prepare.yml
          workflow_conclusion: success
          search_artifacts: true
        continue-on-error: true

      - name: Setup offline environment
        if: github.event.inputs.offline_mode == 'true'
        run: |
          echo "=== Setting up offline mode with NIPR artifacts ==="
          
          # Check if artifacts were downloaded
          if [ -d "nipr-artifacts" ] && [ -n "$(ls -A nipr-artifacts 2>/dev/null)" ]; then
            echo "✓ NIPR artifacts downloaded from GitHub"
            cd nipr-artifacts
            
            # Verify checksums if available
            CHECKSUM_FILE=$(ls spel-nipr-*-checksums.txt 2>/dev/null | head -1)
            if [ -n "$CHECKSUM_FILE" ]; then
              echo "Verifying checksums..."
              if sha256sum -c "$CHECKSUM_FILE"; then
                echo "✓ Checksum verification passed"
              else
                echo "⚠ Checksum verification failed, but continuing..."
              fi
            fi
            
            # Move archives to repository root
            mv spel-*.tar.gz ../ 2>/dev/null || true
            mv spel-nipr-*-checksums.txt ../ 2>/dev/null || true
            mv spel-nipr-*-manifest.txt ../ 2>/dev/null || true
            cd ..
          else
            echo "⚠ No artifacts downloaded - checking for archives in repository..."
          fi
          
          # Check if archives exist (either downloaded or committed to repo)
          if ls spel-*.tar.gz 1> /dev/null 2>&1; then
            echo "✓ Found NIPR transfer archives"
            ls -lh spel-*.tar.gz
            
            # Extract archives
            echo ""
            echo "Extracting NIPR archives..."
            bash ./scripts/extract-nipr-archives.sh
            
            # Verify offline mode files exist
            echo ""
            echo "Verifying offline mode setup..."
            
            if [ -d "spel/ansible/roles" ] && [ -n "$(ls -A spel/ansible/roles 2>/dev/null)" ]; then
              echo "✓ Ansible roles extracted successfully"
              du -sh spel/ansible/roles/
            else
              echo "⚠ Ansible roles directory empty or missing"
            fi
            
            if [ -d "tools/python-deps" ] && [ -n "$(ls -A tools/python-deps 2>/dev/null)" ]; then
              echo "✓ Python dependencies extracted successfully"
              du -sh tools/python-deps/
            else
              echo "⚠ Python dependencies directory empty or missing"
            fi
            
            if [ -d "tools/packer/linux_amd64" ] && [ -f "tools/packer/linux_amd64/packer" ]; then
              echo "✓ Packer binary extracted successfully"
              tools/packer/linux_amd64/packer version
            else
              echo "⚠ Packer binary missing"
            fi
            
            if [ -d "spel/ansible/collections/ansible_collections" ]; then
              echo "✓ Ansible collections extracted successfully"
              du -sh spel/ansible/collections/
            else
              echo "⚠ Ansible collections directory empty or missing"
            fi
            
            if [ -d "offline-packages" ] && [ -n "$(ls -A offline-packages 2>/dev/null)" ]; then
              echo "✓ Offline packages extracted successfully"
              du -sh offline-packages/
            else
              echo "⚠ Offline packages directory empty or missing"
            fi
            
            echo ""
            echo "=== Offline mode setup complete ==="
          else
            echo "✗ No NIPR archives found!"
            echo ""
            echo "To use offline mode, either:"
            echo "  1. Provide a valid nipr_artifact_name from a previous nipr-prepare workflow run"
            echo "  2. Commit the NIPR archives to a test branch"
            echo "  3. Manually upload archives to the repository"
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::879381286673:role/Packer_Amazon
          role-duration-seconds: 43200

      - name: Set up environment
        run: |
          echo "Setting up environment variables"

          echo "SPEL_IDENTIFIER=spel" >> $GITHUB_ENV
          
          # Detect offline mode (for local testing with network isolation)
          if [ -f "offline-packages/awscli-exe-linux-x86_64.zip" ] || [ -d "tools/python-deps" ] || [ -d "spel/ansible/collections/ansible_collections" ]; then
            echo "SPEL_OFFLINE_MODE=true" >> $GITHUB_ENV
            echo "✓ Detected offline mode - using vendored packages"
            
            # Display offline mode info
            echo ""
            echo "=== Offline Mode Active ==="
            echo "Python deps: $(du -sh tools/python-deps 2>/dev/null | awk '{print $1}' || echo 'N/A')"
            echo "Packer: $(tools/packer/linux_amd64/packer version 2>/dev/null | head -1 || echo 'N/A')"
            echo "Collections: $(du -sh spel/ansible/collections 2>/dev/null | awk '{print $1}' || echo 'N/A')"
            echo "Roles: $(du -sh spel/ansible/roles 2>/dev/null | awk '{print $1}' || echo 'N/A')"
            echo "Packages: $(du -sh offline-packages 2>/dev/null | awk '{print $1}' || echo 'N/A')"
            echo "SPEL packages: $(du -sh spel-packages 2>/dev/null | awk '{print $1}' || echo 'N/A')"
            echo "==========================="
            echo ""
          else
            echo "SPEL_OFFLINE_MODE=false" >> $GITHUB_ENV
            echo "Online mode - will download packages from internet"
          fi

          builders=""
          if [[ "${{ github.event.inputs.run_amzn2023 }}" == "true" ]]; then
            builders+="amazon-ebssurrogate.minimal-amzn-2023-hvm,"
          fi
          if [[ "${{ github.event.inputs.run_ol9 }}" == "true" ]]; then
            builders+="amazon-ebssurrogate.minimal-ol-9-hvm,"
          fi
          if [[ "${{ github.event.inputs.run_rhel9 }}" == "true" ]]; then
            builders+="amazon-ebssurrogate.minimal-rhel-9-hvm,"
          fi
          if [[ "${{ github.event.inputs.run_ol8 }}" == "true" ]]; then
            builders+="amazon-ebssurrogate.minimal-ol-8-hvm,"
          fi
          if [[ "${{ github.event.inputs.run_rhel8 }}" == "true" ]]; then
            builders+="amazon-ebssurrogate.minimal-rhel-8-hvm,"
          fi
          builders="${builders%,}"
          echo "SPEL_BUILDERS=$builders" >> $GITHUB_ENV

          windows_builders=""
          if [[ "${{ github.event.inputs.run_ws2016 }}" == "true" ]]; then
            windows_builders+="amazon-ebs.hardened-windows-2016-hvm,"
          fi
          if [[ "${{ github.event.inputs.run_ws2019 }}" == "true" ]]; then
            windows_builders+="amazon-ebs.hardened-windows-2019-hvm,"
          fi
          if [[ "${{ github.event.inputs.run_ws2022 }}" == "true" ]]; then
            windows_builders+="amazon-ebs.hardened-windows-2022-hvm,"
          fi
          windows_builders="${windows_builders%,}"
          echo "WINDOWS_BUILDERS=$windows_builders" >> $GITHUB_ENV

          echo "SPEL_VERSION=$(date +%Y.%m).1" >> $GITHUB_ENV
          echo "PKR_VAR_aws_force_deregister=true" >> $GITHUB_ENV
          echo "PKR_VAR_aws_ami_regions=[\"us-east-1\"]" >> $GITHUB_ENV

          echo "PKR_VAR_aws_ami_groups=[\"all\"]" >> $GITHUB_ENV

          echo "PKR_VAR_aws_region=us-east-1" >> $GITHUB_ENV
          echo "PACKER_GITHUB_API_TOKEN=${{ secrets.PACKER_GITHUB_API_TOKEN }}" >> $GITHUB_ENV

          echo "AWS_COMMERCIAL_ACCESS_KEY_ID=${{ secrets.AWS_COMMERCIAL_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_COMMERCIAL_SECRET_ACCESS_KEY=${{ secrets.AWS_COMMERCIAL_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_GOVCLOUD_ACCESS_KEY_ID=${{ secrets.AWS_GOVCLOUD_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_GOVCLOUD_SECRET_ACCESS_KEY=${{ secrets.AWS_GOVCLOUD_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV

      - name: Initialize Git Submodules
        run: |
          git submodule update --init --recursive

      - name: Setup Build Environment
        run: |
          bash build/ci-setup.sh

      - name: Build STIGed AMI's
        run: |
          make -f Makefile.spel build

      # - name: Copy STIGed AMI's to GovCloud
      #   if: github.event.inputs.govcloud == 'true'
      #   run: |
      #     make -f Makefile.spel copy

      # - name: Check if README.md needs update
      #   id: check_readme
      #   run: |
      #     if grep -q "$(date +%Y.%m)" README.md; then
      #       echo "update_needed=false" >> $GITHUB_OUTPUT
      #     else
      #       echo "update_needed=true" >> $GITHUB_OUTPUT
      #     fi

      # - name: Update README.md with current month
      #   if: steps.check_readme.outputs.update_needed == 'true'
      #   run: |
      #     sed -i "s/$(date -d 'last month' +%Y.%m)/$(date +%Y.%m)/g" README.md
      #     git config user.name "github-actions[bot]"
      #     git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      #     git commit -a -m "Bump version to $(date +%Y.%m).1"
      #     git push
